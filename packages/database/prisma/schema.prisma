generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// ENUMS
// ============================================================

enum UserRole {
  customer
  viewer
  editor
  store_manager
  admin
  super_admin
}

enum PageStatus {
  draft
  review
  published
  archived
}

enum ProductType {
  physical
  virtual
  service
  configurable
  course
}

enum ProductStatus {
  draft
  active
  archived
}

enum OrderStatus {
  pending
  confirmed
  processing
  shipped
  in_transit
  delivered
  completed
  cancelled
  refunded
  returned
}

enum OrderLineItemStatus {
  pending
  confirmed
  processing
  shipped
  fulfilled
  delivered
  completed
  cancelled
  refunded
  returned
  scheduled
  in_progress
  no_show
  rescheduled
}

enum LicenseKeyStatus {
  available
  allocated
  revoked
}

enum ServiceBookingStatus {
  confirmed
  rescheduled
  completed
  cancelled
  no_show
}

enum ShipmentStatus {
  label_created
  picked_up
  in_transit
  out_for_delivery
  delivered
  exception
}

enum SyncStatus {
  success
  partial
  failed
}

enum CourseStatus {
  draft
  published
  archived
}

enum EnrollmentStatus {
  active
  completed
  suspended
}

// ============================================================
// USER & AUTH
// ============================================================

model User {
  id              String    @id @default(uuid()) @db.Uuid
  email           String    @unique @db.VarChar(255)
  name            String    @db.VarChar(255)
  passwordHash    String    @map("password_hash") @db.Text
  role            UserRole  @default(customer)
  sfContactId     String?   @map("sf_contact_id") @db.Text
  stripeCustId    String?   @map("stripe_cust_id") @db.Text
  failedLogins    Int       @default(0) @map("failed_logins")
  lockedUntil     DateTime? @map("locked_until")
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  pages           Page[]
  pageVersions    PageVersion[]
  mediaAssets     Media[]
  orders          Order[]
  serviceBookings ServiceBooking[]
  auditLogs       AuditLog[]

  // LMS relations
  authoredCourses Course[]         @relation("CourseAuthor")
  courseVersions  CourseVersion[]  @relation("CourseVersionAuthor")
  courseLessons   CourseLesson[]   @relation("CourseLessonAuthor")
  lessonVersions  CourseLessonVersion[] @relation("CourseLessonVersionAuthor")
  enrollments     CourseEnrollment[] @relation("StudentEnrollments")
  gradedQuizzes   QuizAttempt[]    @relation("QuizGrader")

  @@map("users")
}

// ============================================================
// CONTENT: PAGES & VERSIONS
// ============================================================

model Page {
  id              String     @id @default(uuid()) @db.Uuid
  slug            String     @unique @db.VarChar(500)
  title           String     @db.VarChar(255)
  status          PageStatus @default(draft)
  seo             Json?      @db.JsonB
  componentTree   Json       @default("{}") @map("component_tree") @db.JsonB
  version         Int        @default(1)
  isTemplate      Boolean    @default(false) @map("is_template")
  templateName    String?    @map("template_name") @db.VarChar(255)
  parentId        String?    @map("parent_id") @db.Uuid
  position        Int        @default(0)
  publishedAt     DateTime?  @map("published_at")
  scheduledAt     DateTime?  @map("scheduled_at")
  createdBy       String     @map("created_by") @db.Uuid
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  author          User       @relation(fields: [createdBy], references: [id])
  parent          Page?      @relation("PageHierarchy", fields: [parentId], references: [id])
  children        Page[]     @relation("PageHierarchy")
  versions        PageVersion[]

  @@index([slug, status])
  @@index([status])
  @@index([parentId])
  @@index([isTemplate])
  @@index([scheduledAt])
  @@map("pages")
}

model PageVersion {
  id              String   @id @default(uuid()) @db.Uuid
  pageId          String   @map("page_id") @db.Uuid
  version         Int
  componentTree   Json     @map("component_tree") @db.JsonB
  seo             Json?    @db.JsonB
  title           String   @db.VarChar(255)
  createdBy       String   @map("created_by") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at")

  page            Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)
  author          User     @relation(fields: [createdBy], references: [id])

  @@unique([pageId, version])
  @@index([pageId])
  @@map("page_versions")
}

// ============================================================
// MEDIA
// ============================================================

model Media {
  id              String   @id @default(uuid()) @db.Uuid
  filename        String   @db.VarChar(500)
  originalName    String   @map("original_name") @db.VarChar(500)
  mimeType        String   @map("mime_type") @db.VarChar(100)
  size            Int
  s3Key           String   @map("s3_key") @db.Text
  altText         String?  @map("alt_text") @db.VarChar(500)
  dimensions      Json?    @db.JsonB
  variants        Json?    @db.JsonB // { thumbnail: s3Key, medium: s3Key, large: s3Key, webp: s3Key }
  createdBy       String   @map("created_by") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at")

  author          User     @relation(fields: [createdBy], references: [id])

  // LMS relations
  courseThumbnails Course[] @relation("CourseThumbnail")
  lessonVideos     CourseLesson[] @relation("LessonVideo")
  certificates     Certificate[] @relation("CertificatePDF")

  @@index([mimeType])
  @@index([createdAt])
  @@map("media")
}

// ============================================================
// NAVIGATION & REDIRECTS
// ============================================================

model Navigation {
  id              String   @id @default(uuid()) @db.Uuid
  location        String   @unique @db.VarChar(50) // header, footer, sidebar, mobile
  items           Json     @db.JsonB // Array of menu items with nesting
  updatedAt       DateTime @updatedAt @map("updated_at")
  createdAt       DateTime @default(now()) @map("created_at")

  @@map("navigation")
}

model Redirect {
  id              String   @id @default(uuid()) @db.Uuid
  fromPath        String   @unique @map("from_path") @db.Text
  toPath          String   @map("to_path") @db.Text
  statusCode      Int      @default(301) @map("status_code")
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([fromPath])
  @@map("redirects")
}

// ============================================================
// PRODUCTS & CATEGORIES
// ============================================================

model Product {
  id              String        @id @default(uuid()) @db.Uuid
  sku             String        @unique @db.VarChar(100)
  name            String        @db.VarChar(255)
  slug            String        @unique @db.VarChar(500)
  description     String?       @db.Text
  shortDescription String?      @map("short_description") @db.VarChar(500)
  type            ProductType
  status          ProductStatus @default(draft)
  pricing         Json          @db.JsonB
  shipping        Json?         @db.JsonB      // Physical product shipping details
  digital         Json?         @db.JsonB      // Virtual product delivery details
  service         Json?         @db.JsonB      // Service product booking details
  configuration   Json?         @db.JsonB      // Configurable product steps
  course          Json?         @db.JsonB      // Course product (courseId, accessDuration)
  variantAttrs    Json?         @map("variant_attrs") @db.JsonB
  variants        Json?         @db.JsonB      // Array of variant objects
  images          Json?         @db.JsonB      // Array of image objects
  seo             Json?         @db.JsonB
  relatedProducts String[]      @default([]) @map("related_products") @db.Uuid
  crossSells      String[]      @default([]) @map("cross_sells") @db.Uuid
  upSells         String[]      @default([]) @map("up_sells") @db.Uuid
  tags            String[]      @default([])
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  categories      ProductCategory[]
  licenseKeyPools LicenseKeyPool[]

  @@index([type, status])
  @@index([slug])
  @@index([sku])
  @@index([status])
  @@map("products")
}

model Category {
  id              String    @id @default(uuid()) @db.Uuid
  name            String    @db.VarChar(255)
  slug            String    @unique @db.VarChar(500)
  description     String?   @db.Text
  parentId        String?   @map("parent_id") @db.Uuid
  position        Int       @default(0)
  image           String?   @db.Text
  seo             Json?     @db.JsonB
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  parent          Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children        Category[] @relation("CategoryHierarchy")
  products        ProductCategory[]

  @@index([slug])
  @@index([parentId])
  @@map("categories")
}

model ProductCategory {
  productId       String   @map("product_id") @db.Uuid
  categoryId      String   @map("category_id") @db.Uuid
  position        Int      @default(0)

  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category        Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([productId, categoryId])
  @@map("product_categories")
}

// ============================================================
// ORDERS & EVENTS
// ============================================================

model Order {
  id              String      @id @default(uuid()) @db.Uuid
  orderNumber     String      @unique @map("order_number") @db.VarChar(50)
  userId          String?     @map("user_id") @db.Uuid
  guestEmail      String?     @map("guest_email") @db.VarChar(255)
  status          OrderStatus @default(pending)
  lineItems       Json        @map("line_items") @db.JsonB
  subtotal        Int         // cents
  tax             Int         @default(0) // cents
  shippingCost    Int         @default(0) @map("shipping_cost") // cents
  discount        Int         @default(0) // cents
  total           Int         // cents
  currency        String      @default("USD") @db.VarChar(3)
  shippingAddress Json?       @map("shipping_address") @db.JsonB
  billingAddress  Json?       @map("billing_address") @db.JsonB
  stripePaymentIntentId String? @map("stripe_pi_id") @db.Text
  sfOpportunityId String?     @map("sf_opp_id") @db.Text
  couponCode      String?     @map("coupon_code") @db.VarChar(100)
  notes           String?     @db.Text
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  user            User?       @relation(fields: [userId], references: [id])
  events          OrderEvent[]
  shipments       Shipment[]
  serviceBookings ServiceBooking[]
  licenseKeys     LicenseKey[]
  enrollments     CourseEnrollment[]

  @@index([userId, status])
  @@index([orderNumber])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

model OrderEvent {
  id              String   @id @default(uuid()) @db.Uuid
  orderId         String   @map("order_id") @db.Uuid
  eventType       String   @map("event_type") @db.VarChar(100)
  payload         Json?    @db.JsonB
  createdAt       DateTime @default(now()) @map("created_at")

  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([eventType])
  @@map("order_events")
}

// ============================================================
// SHIPPING
// ============================================================

model Shipment {
  id              String         @id @default(uuid()) @db.Uuid
  orderId         String         @map("order_id") @db.Uuid
  carrier         String         @db.VarChar(50)
  service         String         @db.VarChar(100)
  trackingNumber  String?        @map("tracking_number") @db.VarChar(100)
  labelUrl        String?        @map("label_url") @db.Text
  status          ShipmentStatus @default(label_created)
  shipFrom        Json           @map("ship_from") @db.JsonB
  shipTo          Json           @map("ship_to") @db.JsonB
  packages        Json           @db.JsonB
  rateCents       Int            @map("rate_cents")
  currency        String         @default("USD") @db.VarChar(3)
  trackingEvents  Json?          @map("tracking_events") @db.JsonB
  shippedAt       DateTime?      @map("shipped_at")
  deliveredAt     DateTime?      @map("delivered_at")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  order           Order          @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([status])
  @@index([trackingNumber])
  @@map("shipments")
}

// ============================================================
// LICENSE KEYS (Virtual Products)
// ============================================================

model LicenseKeyPool {
  id              String       @id @default(uuid()) @db.Uuid
  productId       String       @map("product_id") @db.Uuid
  name            String       @db.VarChar(255)
  createdAt       DateTime     @default(now()) @map("created_at")

  product         Product      @relation(fields: [productId], references: [id])
  keys            LicenseKey[]

  @@index([productId])
  @@map("license_key_pools")
}

model LicenseKey {
  id              String           @id @default(uuid()) @db.Uuid
  poolId          String           @map("pool_id") @db.Uuid
  keyValue        String           @unique @map("key_value") @db.Text
  status          LicenseKeyStatus @default(available)
  orderId         String?          @map("order_id") @db.Uuid
  allocatedAt     DateTime?        @map("allocated_at")
  expiresAt       DateTime?        @map("expires_at")
  createdAt       DateTime         @default(now()) @map("created_at")

  pool            LicenseKeyPool   @relation(fields: [poolId], references: [id], onDelete: Cascade)
  order           Order?           @relation(fields: [orderId], references: [id])

  @@index([poolId, status])
  @@index([orderId])
  @@map("license_keys")
}

// ============================================================
// SERVICE BOOKINGS
// ============================================================

model ServiceBooking {
  id              String               @id @default(uuid()) @db.Uuid
  orderId         String               @map("order_id") @db.Uuid
  productId       String               @map("product_id") @db.Uuid
  userId          String               @map("user_id") @db.Uuid
  scheduledAt     DateTime             @map("scheduled_at")
  durationMinutes Int                  @map("duration_minutes")
  status          ServiceBookingStatus @default(confirmed)
  calendarEventId String?              @map("calendar_event_id") @db.Text
  notes           String?              @db.Text
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")

  order           Order                @relation(fields: [orderId], references: [id])
  user            User                 @relation(fields: [userId], references: [id])

  @@index([orderId])
  @@index([userId])
  @@index([scheduledAt])
  @@index([status])
  @@map("service_bookings")
}

// ============================================================
// INTEGRATIONS & SYNC LOG
// ============================================================

model Integration {
  id              String   @id @default(uuid()) @db.Uuid
  type            String   @unique @db.VarChar(50) // stripe, ga4, salesforce
  config          Json     @db.JsonB
  credentials     Bytes?   // encrypted
  status          String   @default("inactive") @db.VarChar(20)
  lastSyncAt      DateTime? @map("last_sync_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("integrations")
}

model SyncLog {
  id              String     @id @default(uuid()) @db.Uuid
  integration     String     @db.VarChar(50)
  direction       String     @db.VarChar(20) // inbound, outbound
  entityType      String     @map("entity_type") @db.VarChar(50)
  entityId        String     @map("entity_id") @db.Text
  status          SyncStatus
  errorMsg        String?    @map("error_msg") @db.Text
  durationMs      Int?       @map("duration_ms")
  createdAt       DateTime   @default(now()) @map("created_at")

  @@index([integration, status])
  @@index([createdAt])
  @@map("sync_log")
}

// ============================================================
// COUPONS
// ============================================================

model Coupon {
  id              String    @id @default(uuid()) @db.Uuid
  code            String    @unique @db.VarChar(50)
  description     String?   @db.VarChar(255)
  discountType    String    @map("discount_type") @db.VarChar(20) // percentage, fixed_amount, free_shipping, buy_x_get_y
  discountValue   Int       @map("discount_value") // percentage * 100 or cents
  maxDiscountAmount Int?    @map("max_discount_amount") // cap on discount in cents (for percentage coupons)

  // --- Targeting: include rules (empty = all) ---
  appliesTo       String    @default("all") @map("applies_to") @db.VarChar(20) // all, specific_products, specific_categories
  productIds      String[]  @default([]) @map("product_ids") @db.Uuid
  categoryIds     String[]  @default([]) @map("category_ids") @db.Uuid
  productTypes    String[]  @default([]) @map("product_types") // physical, virtual, service, configurable, course

  // --- Targeting: exclude rules ---
  excludedProductIds  String[]  @default([]) @map("excluded_product_ids") @db.Uuid
  excludedCategoryIds String[]  @default([]) @map("excluded_category_ids") @db.Uuid

  // --- Cart thresholds ---
  minOrderAmount  Int?      @map("min_order_amount") // cents
  maxOrderAmount  Int?      @map("max_order_amount") // cents (ceiling â€” coupon only valid up to this cart total)
  minItemCount    Int?      @map("min_item_count") // minimum number of qualifying items in cart

  // --- Usage limits ---
  maxUsageCount   Int?      @map("max_usage_count") // global max uses (null = unlimited)
  usagePerUser    Int?      @map("usage_per_user") // per-customer limit (null = unlimited)
  currentUsage    Int       @default(0) @map("current_usage")

  // --- Stacking rules ---
  stackable       Boolean   @default(false) // can this coupon be combined with others?
  stackGroup      String?   @map("stack_group") @db.VarChar(50) // coupons in same group can't stack
  priority        Int       @default(0) // when multiple coupons apply, higher priority wins

  // --- Buy X Get Y ---
  buyXQuantity    Int?      @map("buy_x_quantity") // buy X items...
  getYQuantity    Int?      @map("get_y_quantity") // ...get Y items discounted

  // --- Integration & dates ---
  stripeCouponId  String?   @map("stripe_coupon_id") @db.Text
  startsAt        DateTime? @map("starts_at")
  expiresAt       DateTime? @map("expires_at")
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@index([code])
  @@index([isActive])
  @@map("coupons")
}

// ============================================================
// AUDIT LOG
// ============================================================

model AuditLog {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  action          String   @db.VarChar(100) // page.publish, order.refund, etc.
  resourceType    String   @map("resource_type") @db.VarChar(50)
  resourceId      String   @map("resource_id") @db.Text
  details         Json?    @db.JsonB
  ipAddress       String?  @map("ip_address") @db.VarChar(45)
  result          String   @default("success") @db.VarChar(20)
  createdAt       DateTime @default(now()) @map("created_at")

  user            User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([resourceType, resourceId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================================
// SITE SETTINGS (key-value store for global configuration)
// ============================================================

model SiteSettings {
  id        String   @id @default(uuid()) @db.Uuid
  key       String   @unique @db.VarChar(100) // general, theme, seo, analytics, payments, system
  value     Json     @db.JsonB
  updatedAt DateTime @updatedAt @map("updated_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("site_settings")
}

// ============================================================
// PROCESSED WEBHOOK EVENTS (Idempotency)
// ============================================================

model ProcessedEvent {
  id              String   @id @db.VarChar(255) // Stripe event ID or similar
  source          String   @db.VarChar(50) // stripe, salesforce, etc.
  processedAt     DateTime @default(now()) @map("processed_at")

  @@index([source])
  @@map("processed_events")
}

// ============================================================
// LMS (LEARNING MANAGEMENT SYSTEM)
// ============================================================

// Main course container
model Course {
  id              String        @id @default(uuid()) @db.Uuid
  title           String        @db.VarChar(255)
  slug            String        @unique @db.VarChar(500)
  description     String?       @db.Text
  version         Int           @default(1)
  status          CourseStatus  @default(draft)

  // Course metadata (JSONB)
  courseMetadata  Json?         @map("course_metadata") @db.JsonB
  // { learningObjectives: [], prerequisites: [], estimatedHours: 10, difficulty: 'beginner' }

  thumbnailUrl    String?       @map("thumbnail_url")
  thumbnailMediaId String?      @map("thumbnail_media_id") @db.Uuid
  instructorName  String?       @map("instructor_name") @db.VarChar(255)
  instructorBio   String?       @map("instructor_bio") @db.Text

  // Audit fields
  createdBy       String?       @map("created_by") @db.Uuid
  publishedAt     DateTime?     @map("published_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  author          User?         @relation(fields: [createdBy], references: [id], name: "CourseAuthor")
  thumbnailMedia  Media?        @relation(fields: [thumbnailMediaId], references: [id], name: "CourseThumbnail")
  sections        CourseSection[]
  enrollments     CourseEnrollment[]
  versions        CourseVersion[]

  @@index([status, publishedAt])
  @@index([slug])
  @@index([createdBy])
  @@map("courses")
}

// Version history for courses
model CourseVersion {
  id              String   @id @default(uuid()) @db.Uuid
  courseId        String   @map("course_id") @db.Uuid
  version         Int
  title           String   @db.VarChar(255)
  description     String?  @db.Text
  courseMetadata  Json?    @map("course_metadata") @db.JsonB
  createdBy       String   @map("created_by") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at")

  course          Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  author          User     @relation(fields: [createdBy], references: [id], name: "CourseVersionAuthor")

  @@unique([courseId, version])
  @@index([courseId])
  @@map("course_versions")
}

// Organize lessons into sections/modules
model CourseSection {
  id              String     @id @default(uuid()) @db.Uuid
  courseId        String     @map("course_id") @db.Uuid
  title           String     @db.VarChar(255)
  description     String?    @db.Text
  position        Int        @default(0)  // Order within course
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  course          Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons         CourseLesson[]

  @@index([courseId, position])
  @@map("course_sections")
}

// Individual lesson with video/content
model CourseLesson {
  id              String     @id @default(uuid()) @db.Uuid
  courseSectionId String     @map("course_section_id") @db.Uuid
  title           String     @db.VarChar(255)
  version         Int        @default(1)  // Versionable like Page

  // Content fields
  content         String     @db.Text  // Markdown or HTML content
  videoUrl        String?    @map("video_url")  // External (Vimeo/YouTube) embed URL
  videoProvider   String?    @map("video_provider") @db.VarChar(50)  // vimeo, youtube
  videoDuration   Int?       @map("video_duration_secs")
  videoMediaId    String?    @map("video_media_id") @db.Uuid

  // Slides/attachments (JSONB array)
  attachments     Json?      @db.JsonB
  // [{ type: 'pdf' | 'pptx' | 'docx', title: '', mediaId: '', s3Key: '' }]

  position        Int        @default(0)
  isFree          Boolean    @default(false) @map("is_free")  // Preview lessons

  createdBy       String     @map("created_by") @db.Uuid
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  section         CourseSection @relation(fields: [courseSectionId], references: [id], onDelete: Cascade)
  author          User       @relation(fields: [createdBy], references: [id], name: "CourseLessonAuthor")
  videoMedia      Media?     @relation(fields: [videoMediaId], references: [id], name: "LessonVideo")
  versions        CourseLessonVersion[]
  quizzes         Quiz[]
  progress        CourseProgress[]

  @@index([courseSectionId, position])
  @@map("course_lessons")
}

// Version snapshots for lessons
model CourseLessonVersion {
  id              String   @id @default(uuid()) @db.Uuid
  lessonId        String   @map("lesson_id") @db.Uuid
  version         Int
  content         String   @db.Text
  videoUrl        String?  @map("video_url")
  attachments     Json?    @db.JsonB
  createdBy       String   @map("created_by") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at")

  lesson          CourseLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  author          User     @relation(fields: [createdBy], references: [id], name: "CourseLessonVersionAuthor")

  @@unique([lessonId, version])
  @@index([lessonId])
  @@map("course_lesson_versions")
}

// Student enrollment tracking
model CourseEnrollment {
  id              String           @id @default(uuid()) @db.Uuid
  courseId        String           @map("course_id") @db.Uuid
  userId          String           @map("user_id") @db.Uuid
  orderId         String?          @map("order_id") @db.Uuid  // Link to purchase
  orderLineItemId String?          @map("order_line_item_id") @db.Uuid
  status          EnrollmentStatus @default(active)

  // Enrollment lifecycle timestamps
  enrolledAt      DateTime         @map("enrolled_at")
  completedAt     DateTime?        @map("completed_at")
  lastAccessedAt  DateTime?        @map("last_accessed_at")
  expiresAt       DateTime?        @map("expires_at")  // For time-limited courses

  // Progress tracking
  progressPercent Int              @default(0) @map("progress_percent")  // 0-100

  course          Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user            User             @relation(fields: [userId], references: [id], name: "StudentEnrollments")
  order           Order?           @relation(fields: [orderId], references: [id])
  progress        CourseProgress[]
  quizAttempts    QuizAttempt[]
  certificates    Certificate[]

  @@unique([courseId, userId])  // One enrollment per user per course
  @@index([userId, status])
  @@index([courseId])
  @@map("course_enrollments")
}

// Granular lesson progress tracking
model CourseProgress {
  id              String         @id @default(uuid()) @db.Uuid
  enrollmentId    String         @map("enrollment_id") @db.Uuid
  lessonId        String         @map("lesson_id") @db.Uuid

  isCompleted     Boolean        @default(false) @map("is_completed")
  completedAt     DateTime?      @map("completed_at")
  videoProgress   Int?           @map("video_progress_secs")  // Resume point
  lastViewedAt    DateTime       @default(now()) @map("last_viewed_at")

  enrollment      CourseEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lesson          CourseLesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, lessonId])
  @@index([enrollmentId])
  @@map("course_progress")
}

// Quiz attached to lessons
model Quiz {
  id              String     @id @default(uuid()) @db.Uuid
  lessonId        String     @map("lesson_id") @db.Uuid
  title           String     @db.VarChar(255)
  description     String?    @db.Text

  // Quiz configuration (JSONB)
  quizConfig      Json       @map("quiz_config") @db.JsonB
  // { passingScore: 80, maxAttempts: 3, timeLimit: 1800, shuffleQuestions: true }

  position        Int        @default(0)  // Order within lesson
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  lesson          CourseLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questions       QuizQuestion[]
  attempts        QuizAttempt[]

  @@index([lessonId])
  @@map("quizzes")
}

// Quiz questions
model QuizQuestion {
  id              String     @id @default(uuid()) @db.Uuid
  quizId          String     @map("quiz_id") @db.Uuid
  questionType    String     @map("question_type") @db.VarChar(50)
  // 'multiple_choice' | 'true_false' | 'fill_blank' | 'essay'

  questionText    String     @map("question_text") @db.Text

  // Question data (JSONB)
  questionData    Json       @map("question_data") @db.JsonB
  // For multiple_choice: { options: [{ id, text, isCorrect }], explanation: '' }
  // For true_false: { correctAnswer: true, explanation: '' }
  // For fill_blank: { correctAnswers: ['answer1', 'answer2'], caseSensitive: false }
  // For essay: { rubric: '', maxWords: 500 }

  points          Int        @default(1)
  position        Int        @default(0)
  requiresManualGrading Boolean @default(false) @map("requires_manual_grading")  // true for essay
  createdAt       DateTime   @default(now()) @map("created_at")

  quiz            Quiz       @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([quizId, position])
  @@map("quiz_questions")
}

// Student quiz submissions
model QuizAttempt {
  id              String     @id @default(uuid()) @db.Uuid
  quizId          String     @map("quiz_id") @db.Uuid
  enrollmentId    String     @map("enrollment_id") @db.Uuid
  attemptNumber   Int        @map("attempt_number")  // 1, 2, 3...

  // Answers (JSONB array)
  answers         Json       @db.JsonB
  // [{ questionId: '', answer: '', isCorrect: true|null, pointsEarned: number|null, instructorFeedback: '' }]
  // isCorrect/pointsEarned are null for essay questions until manually graded

  score           Int?       // Total points earned (null until all questions graded)
  totalPoints     Int        @map("total_points")  // Maximum possible
  passed          Boolean?   // null until fully graded

  gradingStatus   String     @default("pending") @map("grading_status") @db.VarChar(50)
  // 'pending' | 'auto_graded' | 'needs_manual_grading' | 'fully_graded'
  gradedBy        String?    @map("graded_by") @db.Uuid  // Instructor who graded essays
  gradedAt        DateTime?  @map("graded_at")

  startedAt       DateTime   @map("started_at")
  completedAt     DateTime   @map("completed_at")

  quiz            Quiz       @relation(fields: [quizId], references: [id], onDelete: Cascade)
  enrollment      CourseEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  grader          User?      @relation(fields: [gradedBy], references: [id], name: "QuizGrader")

  @@unique([quizId, enrollmentId, attemptNumber])
  @@index([enrollmentId])
  @@index([gradingStatus])  // Filter pending grading
  @@map("quiz_attempts")
}

// Generated certificates
model Certificate {
  id              String     @id @default(uuid()) @db.Uuid
  enrollmentId    String     @map("enrollment_id") @db.Uuid
  certificateUrl  String     @map("certificate_url")  // S3 URL for PDF
  certificateMediaId String? @map("certificate_media_id") @db.Uuid

  issuedAt        DateTime   @map("issued_at")
  verificationCode String    @unique @map("verification_code") @db.VarChar(100)

  enrollment      CourseEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  certificateMedia Media?    @relation(fields: [certificateMediaId], references: [id], name: "CertificatePDF")

  @@index([enrollmentId])
  @@index([verificationCode])
  @@map("certificates")
}
